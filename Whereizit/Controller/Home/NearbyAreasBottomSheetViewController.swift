//
//  NearbyAreasBottomSheetViewController.swift
//  Whereizit
//
//  Created by 이상지 on 9/15/25.
//

import FirebaseAuth
import FirebaseFirestore
import FlexLayout
import PinLayout
import Then

import CoreLocation
import UIKit


protocol NearbyAreasDelegate: AnyObject {
  func moveCameraToArea(lat: Double, lng: Double)
  
  func showAreaBottomSheet(areaData: Area)
}


final class NearbyAreasBottomSheetViewController: UIViewController {
  
  weak var delegate: NearbyAreasDelegate?
  
  let user = Auth.auth().currentUser
  
  private let rootContainer = UIView()
  
  private let locationManager = CLLocationManager()
  private var currentLocation: CLLocation?

  private let titleLabel = UILabel().then {
    $0.text = "주변 목록"
    $0.font = .systemFont(ofSize: 15, weight: .regular)
    $0.textAlignment = .center
  }
  
  private let tableView = UITableView().then {
    $0.contentInset = .init(top: 0, left: 0, bottom: 50, right: 0)
  }
  
  let db = Firestore.firestore()
  
  private var areas: [Area] = []

  private var areaName: String = ""
  
  
  override func viewDidLoad() {
    super.viewDidLoad()
    self.view.backgroundColor = .white
    self.fetchAreas()
    
    self.tableView.delegate = self
    self.tableView.dataSource = self
    
    self.tableView.register(AreaTableViewCell.self, forCellReuseIdentifier: "AreaCell")
    self.tableView.rowHeight = UITableView.automaticDimension
    self.tableView.estimatedRowHeight = 120
    
    self.locationManager.delegate = self
    self.locationManager.desiredAccuracy = kCLLocationAccuracyBest
    self.locationManager.requestWhenInUseAuthorization()
    self.locationManager.startUpdatingLocation()

    self.view.addSubview(rootContainer)
    self.setupLayout()
  }
  
  
  override func viewDidLayoutSubviews() {
    super.viewDidLayoutSubviews()
    self.rootContainer.pin.all()
    self.rootContainer.flex.layout()
  }
  
  
  private func setupLayout() {
    self.rootContainer.flex.justifyContent(.start).marginTop(30)
      .alignItems(.center)
      .define {
        $0.addItem(self.titleLabel)
        $0.addItem(self.tableView).height(100%).marginTop(15)
      }
  }
  
  private func fetchAreas() {
    db.collection(Constant.Firestore.Collection.smokingAreas).addSnapshotListener { [weak self] snapshot, error in
      guard let self = self, let snapshot = snapshot else {
        print("스냅샷 에러: \(error?.localizedDescription ?? "Unknown error")")
        return
      }

      var newAreas: [Area] = []

      for doc in snapshot.documents {
        do {
          let area = try doc.data(as: Area.self)
          newAreas.append(area)
        } catch {
          print("⚠️ 데이터 파싱 실패 (ID: \(doc.documentID)): \(error)")
        }
      }

      // 현재 위치가 있으면 거리 기준으로 정렬
      if let currentLocation = self.currentLocation {
        newAreas.sort { a, b in
          let locA = CLLocation(latitude: a.areaLat, longitude: a.areaLng)
          let locB = CLLocation(latitude: b.areaLat, longitude: b.areaLng)
          return currentLocation.distance(from: locA) < currentLocation.distance(from: locB)
        }
      }

      self.areas = newAreas
      self.tableView.reloadData()
    }
  }
}


extension NearbyAreasBottomSheetViewController: UITableViewDelegate, UITableViewDataSource {
  func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
    return areas.count
  }
  
  func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
    guard let cell = tableView.dequeueReusableCell(withIdentifier: "AreaCell", for: indexPath)
            as? AreaTableViewCell else { return UITableViewCell() }
    
    let area = areas[indexPath.row]

    // area 데이터 cell의 configure에 넘겨주기
    cell.configure(with: area, currentLocation: self.currentLocation)
    
    return cell
  }
  
  func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
    let area = areas[indexPath.row]
    delegate?.moveCameraToArea(lat: area.areaLat, lng: area.areaLng)
    delegate?.showAreaBottomSheet(areaData: area)
    
    tableView.deselectRow(at: indexPath, animated: true)
  }
}


extension NearbyAreasBottomSheetViewController: CLLocationManagerDelegate {
  func locationManager(_ manager: CLLocationManager, didUpdateLocations locations: [CLLocation]) {
      self.currentLocation = locations.last
      
      // 거리 기준 정렬
      if let currentLocation = self.currentLocation {
          self.areas.sort { a, b in
              let locA = CLLocation(latitude: a.areaLat, longitude: a.areaLng)
              let locB = CLLocation(latitude: b.areaLat, longitude: b.areaLng)
              return currentLocation.distance(from: locA) < currentLocation.distance(from: locB)
          }
      }
      
      self.tableView.reloadData() // 위치 업데이트되면 거리 표시 갱신
  }
  
  func locationManager(_ manager: CLLocationManager, didFailWithError error: Error) {
      print("Location error: \(error.localizedDescription)")
  }
}
